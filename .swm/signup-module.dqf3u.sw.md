---
id: dqf3u
title: Signup Module
file_version: 1.1.1
app_version: 1.0.15
---

## Introduction

This doc gives a high-level overview of the signup module. The signup service is located under `ðŸ“„ src/services/auth.service.ts`.

## Main features

The main features of Signup are: Send the user a verification email to verify his email account. In the email, there's a link that takes him to a page that sends a request with a token and the email account. It your token and email address are valid you'll be able to sign in to the system.

## Design decisions

With the signup service:

<br/>

1.  Check if the email already has been registered.
    
    1.  Yes -> check if the email has been verified
        
        1.  Yes -> Throw Exception with a message that indicates the user has already registered
            
        2.  No -> Send another verification email to that address (generating a new token)
            
    2.  No -> generate a token, create a user document and send a verification email to that address
        

Note:

*   For now, the registration service returns {safeUser, accessToken} because the Front end needs an access token to save in its local storage otherwise it would throw an error.
    
*   I'm planning to change the signup page's redirect route to a message page that says to check the email we just send. After clicking the link in the email, it takes the user to a login page ( if the verification goes well). And then the user can sign in to our system.
    
*   A user won't be allowed to sign in without verifying his email first.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ src/services/auth.service.ts
```typescript
8      async function register({
9          name,
10         email,
11         password,
12         role,
13     }: {
14         name: string
15         email: string
16         password: string
17         role: string
18     }) {
19         // if already reisgtered yet not verified
20         const emailAlreadyExist = await User.findOne({ email })
21         const eventEmitter = emailEventEmitter.sendVerificationEmail()
22         const verificationToken = crypto.randomBytes(40).toString('hex')
23     
24         if (emailAlreadyExist && !emailAlreadyExist.isVerified) {
25             // update user verificationToken and send verification email again
26             const user = await User.findOneAndUpdate(
27                 { email },
28                 { verificationToken },
29                 { new: true, runValidators: true }
30             )
31             eventEmitter.emit('signup', email)
32             // return user!
33     
34             // sign an token for now
35             // will use email system to login
36             const safeUser = utils.createSafeUser(emailAlreadyExist)
37             const accessToken = utils.createJWT({ payload: { user: safeUser } })
38             return { safeUser, accessToken }
39         }
40     
41         if (emailAlreadyExist && emailAlreadyExist.isVerified) {
42             throw new CustomError.BadRequestError('Email already registered')
43         }
44     
45         const user = await User.create({
46             name,
47             email,
48             password,
49             role,
50             verificationToken,
51         })
52         eventEmitter.emit('signup', email)
53     
54         // sign an token for now
55         // will use email system to login
56         const safeUser = utils.createSafeUser(user)
57         const accessToken = utils.createJWT({ payload: { user: safeUser } })
58         return { safeUser, accessToken }
59     }
```

<br/>

## Glossary

Here are some important terms to know:

{{ evenEmitter }} is what I use to send user emails. Right now it's a simple event emitter. I'm willing to create a customized event emitter if I use more of this in the future.

<br/>

<br/>

This file was generated by Swimm. [Click here to view it in the app](https://app.swimm.io/repos/Z2l0aHViJTNBJTNBc2NydW0tdHJhY2tlci1iZSUzQSUzQWx1bGlhbjY2Ng==/docs/dqf3u).
